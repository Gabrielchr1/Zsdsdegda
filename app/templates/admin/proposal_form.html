{% extends "admin/base_admin.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mt-4">{{ title }}</h2>
        <p class="lead text-muted">Para o cliente: <strong>{{ client.name }}</strong></p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}<div class="alert alert-{{ messages[0][0] }} alert-dismissible fade show">{{ messages[0][1] }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endif %}
{% endwith %}

<div class="card shadow-sm">
    <div class="card-body p-4">
        <form method="POST" action="" novalidate id="proposalCreationForm">
            {{ form.hidden_tag() }}
            {{ form.proposal_items_json(id="proposal_items_json") }}

            <h4 class="text-muted fw-light mb-3">Dados Gerais da Proposta</h4>
            <div class="row align-items-center"> 
                <div class="col-md-5 mb-3"> {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-control", placeholder="Ex: Proposta Residencial Família Silva") }}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.valid_until.label(class="form-label") }}
                    {{ form.valid_until(class="form-control", type="date") }}
                </div>
                <div class="col-md-4 mb-3"> <label class="form-label">Forma de Análise</label>
                    <div class="d-flex pt-2">
                        {% for subfield in form.consumption_input_type %}<div class="form-check me-3">{{ subfield(class="form-check-input") }} {{ subfield.label(class="form-check-label") }}</div>{% endfor %}
                    </div>
                </div>
            </div>

            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Dados de Consumo e Tarifas</h4>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <div id="kwh-input-group">{{ form.avg_consumption_kwh.label(class="form-label") }}{{ form.avg_consumption_kwh(class="form-control", id="avg_consumption_kwh") }}</div>
                    <div id="brl-input-group" class="d-none">
                        {{ form.avg_bill_brl.label(class="form-label") }}
                        <div class="input-group"><span class="input-group-text">R$</span>{{ form.avg_bill_brl(class="form-control", id="avg_bill_brl") }}</div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.kwh_price.label(class="form-label") }}
                    {{ form.kwh_price(class="form-control", id="kwh_price", placeholder="Ex: 0.95") }}
                </div>
                <div class="col-md-4 mb-3"> {{ form.public_lighting_fee.label(class="form-label") }}
                    <div class="input-group"><span class="input-group-text">R$</span>{{ form.public_lighting_fee(class="form-control", placeholder="Ex: 25.50") }}</div>
                </div>
            </div>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    {{ form.grid_type.label(class="form-label") }}
                    {{ form.grid_type(class="form-select") }}
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.concessionaria.label(class="form-label") }}
                    {{ form.concessionaria(class="form-select", id="concessionaria") }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Irradiação Solar (Hsp)</label>
                    <div class="input-group">
                        {{ form.solar_irradiance(class="form-control", id="solar_irradiance") }}
                        <button class="btn btn-outline-secondary" type="button" id="fetchIrradianceBtn" data-client-id="{{ client.id }}">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span><i class="fas fa-search-location"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>

            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Itens da Proposta</h4>
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Itens do Sistema</h5>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
                        <i class="fas fa-plus"></i> Adicionar Item do Catálogo
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Qtd.</th>
                                    <th></th> </tr>
                            </thead>
                            <tbody id="items_table_body">
                                <tr><td colspan="3" class="text-center text-muted p-4">Nenhum item adicionado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Detalhes Financeiros e Observações</h4>
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.total_investment.label(class="form-label") }}
                    <div class="input-group"><span class="input-group-text">R$</span>{{ form.total_investment(class="form-control", placeholder="Valor total do projeto") }}</div>
                </div>
                </div>
            <div class="mb-3">
                {{ form.notes.label(class="form-label") }}
                {{ form.notes(class="form-control", rows=3) }}
            </div>

            <hr class="form-section-divider">
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('main.clients') }}" class="btn btn-light">Cancelar</a>
                {{ form.submit(class="btn btn-success") }}
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="addConcessionariaModal" tabindex="-1" aria-hidden="true">
    </div>

<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="modalItemForm" novalidate>
                {{ item_form.hidden_tag() }}
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">Adicionar Item do Catálogo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        {{ item_form.product.label(class="form-label") }}
                        {{ item_form.product(class="form-select", id="item_form_product") }}
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ item_form.quantity.label(class="form-label") }}
                            {{ item_form.quantity(class="form-control", id="item_form_quantity") }}
                        </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="addItemBtn">Adicionar Item</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}