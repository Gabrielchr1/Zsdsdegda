{% extends "admin/base_admin.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mt-4">{{ title }}</h2>
        <p class="lead text-muted">Para o cliente: <strong>{{ client.name }}</strong></p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}<div class="alert alert-{{ messages[0][0] }} alert-dismissible fade show">{{ messages[0][1] }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endif %}
{% endwith %}

<div class="card shadow-sm">
    <div class="card-body p-4">
        <form method="POST" action="" novalidate id="proposalCreationForm">
            {{ form.hidden_tag() }}
            {{ form.proposal_items_json(id="proposal_items_json") }}

            <h4 class="text-muted fw-light mb-3">Dados Gerais da Proposta</h4>
            <div class="row align-items-center"> 
                <div class="col-md-5 mb-3"> {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-control", placeholder="Ex: Proposta Residencial Família Silva") }}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.valid_until.label(class="form-label") }}
                    {{ form.valid_until(class="form-control", type="date") }}
                </div>
                <div class="col-md-4 mb-3"> <label class="form-label">Forma de Análise</label>
                    <div class="d-flex pt-2">
                        {% for subfield in form.consumption_input_type %}<div class="form-check me-3">{{ subfield(class="form-check-input") }} {{ subfield.label(class="form-check-label") }}</div>{% endfor %}
                    </div>
                </div>
            </div>

            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Dados de Consumo e Tarifas</h4>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <div id="kwh-input-group">{{ form.avg_consumption_kwh.label(class="form-label") }}{{ form.avg_consumption_kwh(class="form-control", id="avg_consumption_kwh") }}</div>
                    <div id="brl-input-group" class="d-none">
                        {{ form.avg_bill_brl.label(class="form-label") }}
                        <div class="input-group"><span class="input-group-text">R$</span>{{ form.avg_bill_brl(class="form-control", id="avg_bill_brl") }}</div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.kwh_price.label(class="form-label") }}
                    {{ form.kwh_price(class="form-control", id="kwh_price", placeholder="Ex: 0.95") }}
                </div>
                <div class="col-md-4 mb-3"> {{ form.public_lighting_fee.label(class="form-label") }}
                    <div class="input-group"><span class="input-group-text">R$</span>{{ form.public_lighting_fee(class="form-control", placeholder="Ex: 25.50") }}</div>
                </div>
            </div>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    {{ form.grid_type.label(class="form-label") }}
                    {{ form.grid_type(class="form-select") }}
                </div>


                <div class="col-md-4 mb-3">
                    {{ form.concessionaria.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.concessionaria(class="form-select", id="concessionaria") }}
                        <button class="btn btn-outline-success" type="button" data-bs-toggle="modal" data-bs-target="#addConcessionariaModal" title="Adicionar nova concessionária">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>


                <div class="col-md-4 mb-3">
                    <label class="form-label">Irradiação Solar (Hsp)</label>
                    <div class="input-group">
                        {{ form.solar_irradiance(class="form-control", id="solar_irradiance") }}
                        <button class="btn btn-outline-secondary" type="button" id="fetchIrradianceBtn" data-client-id="{{ client.id }}">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span><i class="fas fa-search-location"></i> Buscar
                        </button>
                    </div>
                </div>

                <!-- NOVA COLUNA 4 -->
                <div class="col-md-3 mb-3">
                    {{ form.kwh_adjustment.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.kwh_adjustment(class="form-control") }}
                        <span class="input-group-text">kWh</span>
                    </div>
                </div>



            </div>

            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Itens da Proposta</h4>
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Itens do Sistema</h5>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
                        <i class="fas fa-plus"></i> Adicionar Item do Catálogo
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Produto</th>
                                    <th class="text-center">Qtd.</th>
                                    <th></th> </tr>
                            </thead>
                            <tbody id="items_table_body">
                                <tr><td colspan="3" class="text-center text-muted p-4">Nenhum item adicionado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Detalhes Financeiros e Pagamento</h4>

            <div class="row">
                
                <div class="col-md-4 mb-3">
                    {{ form.total_investment.label(class="form-label") }}
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        {{ form.total_investment(class="form-control", placeholder="Valor total") }}
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    {{ form.credit_card_installments.label(class="form-label", text="Cartão de Crédito (Parcelas / Taxa)") }}
                    <div class="input-group">
                        {{ form.credit_card_installments(class="form-control", placeholder="Parcelas") }}
                        <span class="input-group-text">x</span>
                        {{ form.credit_card_interest_rate(class="form-control", placeholder="Taxa") }}
                        <span class="input-group-text">%</span>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    {{ form.financing_installments.label(class="form-label", text="Financiamento (Parcelas / Taxa)") }}
                    <div class="input-group">
                        {{ form.financing_installments(class="form-control", placeholder="Parcelas") }}
                        <span class="input-group-text">x</span>
                        {{ form.financing_interest_rate(class="form-control", placeholder="Taxa") }}
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                
            </div> <div class="mb-3">
                {{ form.notes.label(class="form-label") }}
                {{ form.notes(class="form-control", rows=3) }}
            </div>

            <hr class="form-section-divider">


            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('main.clients') }}" class="btn btn-light">Cancelar</a>
                {{ form.submit(class="btn btn-success") }}
            </div>

            

        </form>
    </div>
</div>

<div class="modal fade" id="addConcessionariaModal" tabindex="-1" aria-labelledby="concessionariaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="concessionariaModalForm" novalidate>
                <div class="modal-header">
                    <h5 class="modal-title" id="concessionariaModalLabel">Adicionar Nova Concessionária</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="concessionaria-modal-alert" class="alert alert-danger d-none" role="alert"></div>

                    {{ concessionaria_form_modal.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ concessionaria_form_modal.name.label(class="form-label") }}
                        {{ concessionaria_form_modal.name(class="form-control", id="concessionaria_form_name") }}
                        <div class="invalid-feedback" id="concessionaria_form_name_error"></div>
                    </div>
                    
                    <div class="mb-3">
                        {{ concessionaria_form_modal.fio_b_price.label(class="form-label") }}
                        {{ concessionaria_form_modal.fio_b_price(class="form-control", id="concessionaria_form_fio_b", placeholder="Ex: 0.075") }}
                         <div class="invalid-feedback" id="concessionaria_form_fio_b_error"></div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="saveConcessionariaBtn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="modalItemForm" novalidate>
                {{ item_form.hidden_tag() }}
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalLabel">Adicionar Item do Catálogo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        {{ item_form.product.label(class="form-label") }}
                        {{ item_form.product(class="form-select", id="item_form_product") }}
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            {{ item_form.quantity.label(class="form-label") }}
                            {{ item_form.quantity(class="form-control", id="item_form_quantity") }}
                        </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="addItemBtn">Adicionar Item</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} <script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- FUNCIONALIDADE DE ADICIONAR CONCESSIONARIA (MODAL) ---
    const concessionariaModalElement = document.getElementById('addConcessionariaModal');
        
    if (concessionariaModalElement) {
        const concessionariaModal = new bootstrap.Modal(concessionariaModalElement);
        
        const saveBtn = document.getElementById('saveConcessionariaBtn');
        const concessionariaForm = document.getElementById('concessionariaModalForm');

        // Elementos de feedback de erro do HTML
        const modalAlert = document.getElementById('concessionaria-modal-alert');
        const nameError = document.getElementById('concessionaria_form_name_error');
        const fioBError = document.getElementById('concessionaria_form_fio_b_error');
        const nameInput = document.getElementById('concessionaria_form_name');
        const fioBInput = document.getElementById('concessionaria_form_fio_b');

        if (saveBtn && concessionariaForm) {
            
            // Ouve o 'click' no BOTÃO, não o 'submit'
            saveBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // A URL é definida aqui, usando url_for
                
                const formAction = "{{ url_for('main.add_concessionaria') }}";

 
                
                const formData = new FormData(concessionariaForm);

                // 1. Ativa o feedback de "loading"
                saveBtn.disabled = true;
                saveBtn.querySelector('.spinner-border').classList.remove('d-none');
                
                // 2. Limpa erros antigos
                modalAlert.classList.add('d-none');
                if (nameInput) nameInput.classList.remove('is-invalid');
                if (fioBInput) fioBInput.classList.remove('is-invalid');
                if (nameError) nameError.textContent = '';
                if (fioBError) fioBError.textContent = '';

                fetch(formAction, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // --- SUCESSO ---
                        const selectConcessionaria = document.getElementById('concessionaria');
                        if (selectConcessionaria) {
                            const newOption = new Option(data.name, data.id);
                            selectConcessionaria.appendChild(newOption);
                            newOption.selected = true; // Seleciona a nova
                            selectConcessionaria.dispatchEvent(new Event('change'));
                        }
                        concessionariaModal.hide();
                        concessionariaForm.reset();

                    } else {
                        // --- ERRO DE VALIDAÇÃO ---
                        if (data.errors) {
                            let generalErrors = [];
                            for (const field in data.errors) {
                                const errorMsg = data.errors[field][0]; 
                                if (field === 'name' && nameInput && nameError) {
                                    nameInput.classList.add('is-invalid');
                                    nameError.textContent = errorMsg;
                                } else if (field === 'fio_b_price' && fioBInput && fioBError) {
                                    fioBInput.classList.add('is-invalid');
                                    fioBError.textContent = errorMsg;
                                } else if (field !== 'csrf_token') {
                                    generalErrors.push(errorMsg);
                                }
                            }
                            if (generalErrors.length > 0 && modalAlert) {
                                modalAlert.textContent = generalErrors.join(' ');
                                modalAlert.classList.remove('d-none');
                            }
                        } else {
                           if(modalAlert) {
                                modalAlert.textContent = 'Erro desconhecido ao salvar.';
                                modalAlert.classList.remove('d-none');
                           }
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro no fetch (Concessionária):', error);
                    if(modalAlert) {
                        modalAlert.textContent = 'Ocorreu um erro de rede ou servidor.';
                        modalAlert.classList.remove('d-none');
                    }
                })
                .finally(() => {
                    // 3. Desativa o feedback de "loading"
                    saveBtn.disabled = false;
                    saveBtn.querySelector('.spinner-border').classList.add('d-none');
                });
            });
        }
    }

});
</script>
{% endblock %}