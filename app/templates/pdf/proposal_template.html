<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Proposta - {{ proposal.title }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/template_pdf.css') }}">
    
    <style>
    </style>
</head>
<body>
    <div class="cover-page">
        <div class="cover-header">
            <div class="logo-container">
                <img src="{{ company_info.logo_b64 }}" alt="Logo da Empresa" class="logo">
                <span class="company-name-logo">Hyper Energia Solar</span>
            </div>
        </div>
    
        <div class="cover-body">
            <h1>{{ proposal.title }}</h1>
            
            <div class="cover-info">
                <p><strong>Cliente:</strong> {{ proposal.client.name }}</p>
                <p><strong>Data:</strong> {{ proposal.creation_date.strftime('%d/%m/%Y') }}</p>
                <p><strong>Validade:</strong> 
                    {% if proposal.valid_until %}{{ proposal.valid_until.strftime('%d/%m/%Y') }}{% else %}A definir{% endif %}
                </p>
                </div>
        </div>
    
        <div class="cover-footer">
            <div class="footer-company-info">
                <p><strong>{{ company_info.name }}</strong></p>
                <p>{{ company_info.address | default ('-')}}</p> <p>CNPJ: {{ company_info.cnpj }}</p>
                <p>Telefone: {{ company_info.phone }}</p>
                <p>Email: {{ company_info.email | default ('contato@hyperenergiasolar.com')}}</p> <p>Site: {{ company_info.website | default ('www.hyperenergiasolar.com.br')}}</p> </div>
            <div class="footer-image">
                 {% if company_info.footer_image_b64 %}
                <img src="{{ company_info.footer_image_b64 }}" alt="Detalhe Visual">
                 {% endif %}
            </div>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="header"><strong>Hyper Energia</strong> | Proposta para {{ proposal.client.name }}</div>

    <div class="content-page">
        
        <div class="intro-page">
            <h2>Uma Nova Era de Energia para Você</h2>
            <p class="lead">Prezado(a) {{ proposal.client.name.split(' ')[0] }},</p> <p>Agradecemos a oportunidade de apresentar esta proposta personalizada para um sistema de energia solar fotovoltaica. Projetamos uma solução sob medida para suas necessidades, visando não apenas a redução de custos com energia, mas também a valorização do seu imóvel e um futuro mais sustentável.</p>
            <p>Nos próximos itens, detalhamos os aspectos técnicos do sistema proposto, a análise financeira do seu investimento e as garantias que asseguram a sua tranquilidade pelos próximos anos.</p>
        </div>

        <h2>Resumo da Solução Técnica</h2>
        <div class="technical-summary">
            <div class="tech-item">
                <i class="fas fa-solar-panel"></i>
                <span>Potência do Sistema</span>
                <strong>{{ "%.2f"|format(proposal.system_power_kwp or 0) }} kWp</strong>
            </div>
            <div class="tech-item">
                <i class="fas fa-bolt"></i>
                <span>Inversor Recomendado</span>
                <strong>{{ "%.1f"|format(proposal.recommended_inverter_kw or 0) }} kW</strong>
            </div>
            <div class="tech-item">
                <i class="fas fa-th"></i>
                <span>Quantidade de Módulos</span>
                <strong>{{ proposal.panel_quantity or 0 }}</strong>
                {% if proposal.panel_power_wp %}<small class="text-muted">({{ proposal.panel_power_wp }} Wp)</small>{% endif %}
            </div>
        </div>
        
        <h2>Detalhes do Kit Fotovoltaico</h2>
        <table class="items-table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Fabricante</th>
                    <th class="text-center">Potência</th>
                    <th class="text-center">Garantia</th>
                    <th class="text-center">Qtd.</th>
                </tr>
            </thead>
            <tbody>
                {% if proposal.items %}
                    {% for item in proposal.items %}
                    <tr>
                        <td><strong>{{ item.product.name }}</strong></td>
                        <td>{{ item.product.manufacturer or '-' }}</td>
                        <td class="text-center">{{ item.product.power_wp or '-' }}{% if item.product.power_wp %} Wp{% endif %}</td>
                        <td class="text-center">{{ item.product.warranty_years or '-' }}{% if item.product.warranty_years %} anos{% endif %}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="5" class="text-center p-3 text-muted">Itens da proposta não detalhados.</td></tr>
                {% endif %}
            </tbody>
        </table>

        <h2>Detalhamento de Gastos e Economia</h2>
        <table class="savings-table">
            <thead>
                <tr><th>Descrição</th><th>Gasto Anual SEM Energia Solar</th><th>Gasto Anual COM Energia Solar</th></tr>
            </thead>
            <tbody>
                {% set old_monthly_bill = proposal.avg_bill_brl or ((proposal.avg_consumption_kwh or 0) * (proposal.kwh_price or 0)) %}
                {% set old_annual_bill = old_monthly_bill * 12 %}
                {% set new_annual_bill = old_annual_bill - (proposal.estimated_savings_per_year or 0) %}
                <tr>
                    <td>Gasto Estimado com Energia</td>
                    <td class="old-bill">R$ {{ "{:,.2f}".format(old_annual_bill or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td>
                    <td class="new-bill">R$ {{ "{:,.2f}".format(new_annual_bill or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td>
                </tr>
                <tr class="total-savings">
                    <td colspan="2">Economia Anual Gerada pelo Sistema</td>
                    <td>R$ {{ "{:,.2f}".format(proposal.estimated_savings_per_year or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td>
                </tr>
            </tbody>
        </table>

        {% if monthly_chart_b64 %}
            <div class="chart-container">
                <h3>Produção Mensal Estimada (kWh)</h3>
                <img src="data:image/png;base64,{{ monthly_chart_b64 }}">
            </div>
        {% endif %}
        
        <h2>Análise de Investimento a Longo Prazo</h2>
        <div class="explanation-box">
            <strong><i class="fas fa-chart-line"></i> Projeção com Inflação Energética:</strong> Nossos cálculos consideram um aumento médio anual na tarifa de energia (ex: {{ energy_inflation_rate | default(8) }}%). Isso demonstra como sua economia tende a crescer ao longo do tempo, tornando o investimento ainda mais vantajoso.
        </div>
        <div class="financial-kpis" style="margin-top: 20px;">
            <div class="kpi-box">
                <div class="icon"><i class="fas fa-chart-pie"></i></div>
                <div class="label">Taxa Interna de Retorno (TIR)</div>
                <div class="value">{{ "%.2f"|format(financials.irr or 0) }}% a.a.</div>
            </div>
            <div class="kpi-box">
                <div class="icon"><i class="fas fa-sack-dollar"></i></div>
                <div class="label">Valor Presente Líquido (VPL)</div>
                <div class="value">R$ {{ "{:,.0f}".format(financials.npv or 0) | replace(',', '.') }}</div>
            </div>
            <div class="kpi-box">
                <div class="icon"><i class="fas fa-coins"></i></div>
                <div class="label">Lucro Estimado em 25 Anos</div>
                <div class="value">R$ {{ "{:,.0f}".format(financials.profit_in_25_years or 0) | replace(',', '.') }}</div>
            </div>
        </div>
        <p style="font-size: 9px; color: var(--light-text); text-align: center; margin-top: 5px;">
            VPL calculado com taxa de desconto de {{ discount_rate | default(6) }}% a.a. O lucro estimado já considera o valor do investimento inicial.
        </p>

        {% if cumulative_cost_chart_b64 %}
            <div class="chart-container">
                <h3>Projeção de Custo Acumulado em 25 Anos</h3>
                <p>O gráfico compara o custo total projetado que você teria com energia da rede (linha vermelha) versus o custo com o sistema solar instalado (linha verde, incluindo o investimento). A área verde representa sua **economia líquida** ao longo do tempo.</p>
                <img src="data:image/png;base64,{{ cumulative_cost_chart_b64 }}">
            </div>
        {% endif %}

        
        <div class="financial-kpis" style="margin-top: 30px; margin-bottom: 25px;">
            <div class="kpi-box">
                <div class="icon"><i class="fas fa-file-invoice-dollar"></i></div>
                <div class="label">Investimento Total</div>
                <div class="value investment">R$ {{ "{:,.2f}".format(proposal.total_investment or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</div>
            </div>
            <div class="kpi-box">
                <div class="icon"><i class="fas fa-piggy-bank"></i></div>
                <div class="label">Economia Anual Estimada</div>
                 <div class="value savings">R$ {{ "{:,.2f}".format(proposal.estimated_savings_per_year or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</div>
            </div>
            <div class="kpi-box">
                <div class="icon"><i class="fas fa-undo-alt"></i></div>
                <div class="label">Retorno do Investimento (Payback)</div>
                <div class="value">{{ "%.1f"|format(proposal.payback_years or 0) }} anos</div>
            </div>
        </div>
        
        <h2>Sua Solução Completa: Serviços e Garantias</h2>
        <div class="dual-section">
            <div class="col">
                <h3>Serviços Inclusos</h3>
                <ul>
                    <li><i class="fa fa-fw fa-solar-panel"></i> <div><strong>Projeto e Homologação</strong><br><small>Cuidamos de toda a burocracia junto à concessionária de energia.</small></div></li>
                    <li><i class="fa fa-fw fa-tools"></i> <div><strong>Instalação Especializada</strong><br><small>Equipe técnica qualificada para uma instalação segura e eficiente.</small></div></li>
                    <li><i class="fa fa-fw fa-chart-line"></i> <div><strong>Monitoramento Online</strong><br><small>Acompanhe a geração de energia do seu sistema em tempo real via app ou web.</small></div></li>
                    <li><i class="fa fa-fw fa-headset"></i> <div><strong>Suporte Pós-Venda</strong><br><small>Conte com nosso time para qualquer dúvida ou necessidade após a instalação.</small></div></li>
                </ul>
            </div>
            <div class="col">
                <h3>Garantias Oferecidas</h3>
                <ul>
                    <li><i class="fa fa-fw fa-microchip"></i> <div><strong>Até 25 Anos de Performance</strong><br><small>Garantia linear de eficiência dos módulos fotovoltaicos.</small></div></li>
                    <li><i class="fa fa-fw fa-bolt"></i> <div><strong>Até 12 Anos no Inversor</strong><br><small>Garantia do fabricante para o coração do seu sistema (varia por modelo).</small></div></li>
                    <li><i class="fa fa-fw fa-hard-hat"></i> <div><strong>1 Ano de Instalação</strong><br><small>Nossa garantia completa sobre todos os serviços executados pela equipe.</small></div></li>
                     <li><i class="fa fa-fw fa-shield-alt"></i> <div><strong>Garantia dos Equipamentos</strong><br><small>Cobertura contra defeitos de fabricação dos componentes.</small></div></li>
               </ul>
            </div>
        </div>

        <div class="client-logos-section">
            <h2>Alguns de Nossos Clientes</h2>
            <div class="client-logos-container">
                <div class="logo-box"><i class="fas fa-store"></i></div>
                <div class="logo-box"><i class="fas fa-tractor"></i></div>
                <div class="logo-box"><i class="fas fa-hospital"></i></div>
                <div class="logo-box"><i class="fas fa-home"></i></div>
                <div class="logo-box"><i class="fas fa-school"></i></div>
                <div class="logo-box"><i class="fas fa-industry"></i></div>
                <div class="logo-box"><i class="fas fa-hotel"></i></div>
                <div class="logo-box"><i class="fas fa-church"></i></div>
                <div class="logo-box"><i class="fas fa-warehouse"></i></div>
                </div>
        </div>

        <div class="signatures-section">
            <div class="signature-box">
                <div class="signature-line"></div>
                <strong>{{ proposal.author.fullname | default(proposal.author.username) }}</strong> <p>{{ proposal.author.title | default('Consultor de Vendas') }} | Hyper Energia Solar</p> <p>contato@hyperenergiasolar.com.br</p>
                 <p>{{ proposal.author.phone | default('') }}</p> </div>
            <div class="signature-box">
                <div class="signature-line"></div>
                <strong>{{ company_info.engineer_name | default('Eng. Responsável') }}</strong> <p>{{ company_info.engineer_title | default('Engenheiro Eletricista') }}</p> <p>CREA: {{ company_info.engineer_crea | default('000000000-0') }}</p> </div>
        </div>
        
    </div> </body>
</html>